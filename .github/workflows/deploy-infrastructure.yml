name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Identity and Permissions
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            echo "=== Current Identity ==="
            az account show --query "{subscription:name, user:user.name}" -o table
            
            echo ""
            echo "=== Service Principal Object ID ==="
            spObjectId=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
            echo "Object ID: $spObjectId"
            
            echo ""
            echo "=== Role Assignments for this Identity ==="
            az role assignment list --assignee $spObjectId --all -o table
            
            echo ""
            echo "=== Key Vault Permissions Check ==="
            kvName="${{ secrets.AZURE_KEYVAULT_NAME }}"
            rgName="rg-recipe-hub-${{ github.event.inputs.environment }}"
            
            echo "Checking permissions on Key Vault: $kvName"
            az role assignment list --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$rgName/providers/Microsoft.KeyVault/vaults/$kvName" --assignee $spObjectId -o table

      - name: Run What-If analysis
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group what-if \
              --name github-deploy-${{ github.run_id }}-${{ github.run_attempt }} \
              --resource-group rg-recipe-hub-${{ github.event.inputs.environment }} \
              --template-file ./infra/main.bicep \
              --parameters environmentName=${{ github.event.inputs.environment }} \
              --parameters location=${{ secrets.AZURE_LOCATION }} \
              --parameters keyVaultName=${{ secrets.AZURE_KEYVAULT_NAME }}

      - name: Deploy Bicep template
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --name github-deploy-${{ github.run_id }}-${{ github.run_attempt }} \
              --resource-group rg-recipe-hub-${{ github.event.inputs.environment }} \
              --template-file ./infra/main.bicep \
              --parameters environmentName=${{ github.event.inputs.environment }} \
              --parameters location=${{ secrets.AZURE_LOCATION }} \
              --parameters keyVaultName=${{ secrets.AZURE_KEYVAULT_NAME }}

      - name: Get deployment outputs
        id: bicep-outputs
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            deploymentName=github-deploy-${{ github.run_id }}-${{ github.run_attempt }}
            
            webAppName=$(az deployment group show \
              --resource-group rg-recipe-hub-${{ github.event.inputs.environment }} \
              --name $deploymentName \
              --query properties.outputs.webAppName.value -o tsv)
            
            webAppUrl=$(az deployment group show \
              --resource-group rg-recipe-hub-${{ github.event.inputs.environment }} \
              --name $deploymentName \
              --query properties.outputs.webAppUrl.value -o tsv)
            
            echo "webAppName=$webAppName" >> $GITHUB_OUTPUT
            echo "webAppUrl=$webAppUrl" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: rg-recipe-hub-${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App Name**: ${{ steps.bicep-outputs.outputs.webAppName }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App URL**: ${{ steps.bicep-outputs.outputs.webAppUrl }}" >> $GITHUB_STEP_SUMMARY
